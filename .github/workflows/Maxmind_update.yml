name: Fetch MaxMind Databases Daily

on:
  schedule:
    - cron: '0 2 * * *'  # Runs daily at 02:00 UTC
  workflow_dispatch:  # Allows manual trigger from GitHub Actions UI

jobs:
  update-geoip:
    runs-on: ubuntu-latest
    environment: maxmind  # Ensures secrets are loaded from the "maxmind" environment

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures full commit history

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests  

      - name: Debug Secrets (Check If They Exist)
        run: |
          [[ -z "${{ secrets.MAXMIND_LICENSE_KEY }}" ]] && echo "‚ùå MAXMIND_LICENSE_KEY is missing!" || echo "‚úÖ MAXMIND_LICENSE_KEY is set"
          [[ -z "${{ secrets.MAXMIND_ACCOUNT_ID }}" ]] && echo "‚ùå MAXMIND_ACCOUNT_ID is missing!" || echo "‚úÖ MAXMIND_ACCOUNT_ID is set"

      - name: Run Fetch Script
        working-directory: Lists/ASNs/correlation_maxmind_geo_db/
        env:
          MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
          MAXMIND_ACCOUNT_ID: ${{ secrets.MAXMIND_ACCOUNT_ID }}
        run: |
          echo "üöÄ Running fetch_maxmind_databases_daily.py..."
          python fetch_maxmind_databases_daily.py || echo "‚ùå Script failed! Check logs."

      - name: List Modified Files and Sizes
        run: |
          echo "üöÄ Checking modified files..."
          git status --short
          echo "üöÄ Listing file sizes..."
          find Lists/ASNs/correlation_maxmind_geo_db/ -type f -exec ls -lh {} +

      - name: Commit and Push Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull --rebase
          
          echo "üöÄ Adding modified files..."
          git add Lists/ASNs/correlation_maxmind_geo_db/*
          
          echo "üöÄ Checking if there are changes to commit..."
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit."
          else
            git commit -m "Update Maxmind DBs"
            git push || echo "‚ùå Push failed! Check repo size & limits."
          fi
