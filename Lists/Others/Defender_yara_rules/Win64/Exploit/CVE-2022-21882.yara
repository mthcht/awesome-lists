rule Exploit_Win64_CVE_2022_21882_PAGY_2147959937_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Win64/CVE-2022-21882.PAGY!MTB"
        threat_id = "2147959937"
        type = "Exploit"
        platform = "Win64: Windows 64-bit platform"
        family = "CVE-2022-21882"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_PEHSTR_EXT"
        threshold = "8"
        strings_accuracy = "Low"
    strings:
        $x_5_1 = {0f b6 0a 48 ff c2 80 f9 e8 74 ?? ff c0 83 f8 14 7c}  //weight: 5, accuracy: Low
        $x_5_2 = {0f b6 08 48 ff c0 80 f9 e8 74 ?? ff c2 83 fa 14 7c}  //weight: 5, accuracy: Low
        $x_2_3 = {c7 44 24 34 20 00 00 00 4c 89 4c 24 38 4c 89 4c 24 58 ff 15 ?? ?? ?? ?? 48 8d 05 07 18 00 00 c7 44 24 34 37 13 00 00 48 8d 4c 24 20 48 89 44 24 60 ff 15}  //weight: 2, accuracy: Low
        $x_2_4 = {c7 45 84 20 00 00 00 48 89 7d 88 48 89 7d a8 ff 15 ?? ?? ?? ?? 48 8d 05 38 21 00 00 c7 45 84 37 13 00 00 48 8d 4c 24 70 48 89 45 b0 ff 15}  //weight: 2, accuracy: Low
        $x_1_5 = "NtUserConsoleControl" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (
            ((1 of ($x_5_*) and 1 of ($x_2_*) and 1 of ($x_1_*))) or
            ((1 of ($x_5_*) and 2 of ($x_2_*))) or
            ((2 of ($x_5_*))) or
            (all of ($x*))
        )
}

